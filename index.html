<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WES WindKompass</title>

  <style>
    :root{
      /* layout */
      --topbar-h: 64px;
      --page-pad-x: 28px;
      --page-pad-y: 28px;

      /* content sizing */
      --inner-max: 1440px;           /* breiter */
      --inner-pad-x: 22px;
      --inner-pad-y: 44px;           /* oben/unten doppelt so viel */

      /* clean white surfaces */
      --surface: rgba(255,255,255,.86);   /* weiss + transparent */
      --surface-strong: rgba(255,255,255,.92);
      --border: rgba(15,23,42,.10);
      --shadow: 0 18px 40px rgba(0,0,0,.18);

      /* bg */
      --bg-overlay: rgba(0,0,0,.30);

      /* motion */
      --snap-ms: 520ms;
      --fade-ms: 1200ms;

      /* text */
      --text: #0f172a;
      --muted: rgba(15,23,42,.62);

      /* controls */
      --btn: rgba(15,23,42,.05);
      --btn-hover: rgba(15,23,42,.08);
      --item-hover: rgba(15,23,42,.04);
      --danger: rgba(225,29,72,.10);
      --danger-hover: rgba(225,29,72,.14);
    }

    *{ box-sizing:border-box; }
    html, body{ height:100%; margin:0; }
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      overflow:hidden;
      background:#000;
    }
    .sr-only{
      position:absolute; width:1px; height:1px; padding:0; margin:-1px;
      overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0;
    }

    /* VIDEO BG */
    #video-bg{ position:fixed; inset:0; z-index:-10; overflow:hidden; }
    #video-bg video{
      position:absolute; inset:0;
      width:100%; height:100%;
      object-fit:cover;
      opacity:0;
      transition: opacity var(--fade-ms) ease;
    }
    #video-bg video.is-visible{ opacity:1; }
    #video-bg .bg-overlay{ position:absolute; inset:0; background: var(--bg-overlay); }

    /* GLOBAL TOPBAR (clean, no logo bubble) */
    #topbar{
      position:fixed;
      top:0; left:0; right:0;
      height: var(--topbar-h);
      z-index: 100;

      background: rgba(255,255,255,.94);
      border-bottom: 1px solid var(--border);
      box-shadow: 0 10px 24px rgba(0,0,0,.12);

      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 10px var(--page-pad-x);
      color: var(--text);
    }

    .brand{
      display:flex;
      align-items:center;
      gap: 12px;
      min-width: 0;
    }
    .brand img{
      width: 38px;
      height: 38px;
      object-fit: contain;
      display:block;
    }
    .brand-title{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:0;
    }
    .brand-title .name{
      font-size: 14px;
      font-weight: 600;
      letter-spacing: .01em;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .brand-title .sub{
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }

    .right{
      display:flex;
      align-items:center;
      gap: 10px;
      position:relative;
    }

    /* profile / weather box */
    .profilebox{
      display:flex;
      align-items:center;
      gap: 10px;

      padding: 6px 10px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(15,23,42,.03);
    }
    .profilebox img{
      width: 34px;
      height: 34px;
      border-radius: 999px;
      object-fit: cover;
      display:block;
      border: 1px solid rgba(15,23,42,.10);
      background:#fff;
    }
    .metas{
      display:flex;
      flex-direction:column;
      line-height: 1.05;
      gap: 4px;
      padding-right: 2px;
    }
    .metas .user{
      font-size: 12px;
      font-weight: 600;
      color: var(--text);
      opacity: .92;
      white-space: nowrap;
    }
    .metas .wx{
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
    }

    .icon-btn{
      width: 40px;
      height: 40px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: var(--btn);
      cursor:pointer;
      display:grid;
      place-items:center;
      transition: background 140ms ease, transform 140ms ease;
      position:relative;
      padding:0;
      color: var(--text);
    }
    .icon-btn:hover{ background: var(--btn-hover); transform: translateY(-1px); }
    .icon-btn:focus{ outline: 2px solid rgba(15,23,42,.18); outline-offset: 2px; }
    .icon-btn svg{ display:block; }

    .badge{
      position:absolute;
      top: 6px;
      right: 6px;
      min-width: 18px;
      height: 18px;
      padding: 0 5px;
      border-radius: 999px;
      background: #e11d48;
      color:#fff;
      font-size: 11px;
      line-height: 18px;
      font-weight: 700;
      text-align:center;
      box-shadow: 0 8px 18px rgba(225,29,72,.22);
    }

    /* dropdowns (light + clean) */
    .dropdown{
      position: fixed;
      top: calc(var(--topbar-h) + 10px);
      right: var(--page-pad-x);
      width: 340px;

      background: var(--surface-strong);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: var(--shadow);

      opacity: 0;
      pointer-events: none;
      transform: translateY(-6px);
      transition: opacity 140ms ease, transform 160ms ease;
      overflow:hidden;
      z-index: 120;
    }
    .dropdown.is-open{
      opacity: 1;
      pointer-events: auto;
      transform: translateY(0);
    }
    .drop-head{
      padding: 12px 14px 10px 14px;
      font-size: 12px;
      letter-spacing: .06em;
      text-transform: uppercase;
      color: rgba(15,23,42,.55);
      border-bottom: 1px solid rgba(15,23,42,.08);
      background: rgba(255,255,255,.65);
    }
    .drop-list{
      list-style:none;
      margin:0;
      padding: 8px;
      display:flex;
      flex-direction:column;
      gap: 4px;
    }
    .drop-item{
      width:100%;
      border: 0;
      border-radius: 12px;
      padding: 10px 10px;
      background: transparent;
      cursor:pointer;
      text-align:left;
      color: var(--text);
      transition: background 140ms ease;
      display:flex;
      flex-direction:column;
      gap: 4px;
    }
    .drop-item:hover{ background: var(--item-hover); }
    .drop-title{ font-weight: 600; font-size: 13px; }
    .drop-sub{ font-size: 12px; color: var(--muted); }

    .sep{
      height:1px;
      background: rgba(15,23,42,.10);
      margin: 6px 8px;
      border:0;
    }
    .drop-item.logout{ background: var(--danger); }
    .drop-item.logout:hover{ background: var(--danger-hover); }

    /* SECTIONS STACK */
    #sections{
      position:fixed;
      inset:0;
      transform: translateY(0);
      transition: transform var(--snap-ms) cubic-bezier(.2,.9,.2,1);
      will-change: transform;
    }
    .section{
      height:100vh;
      padding:
        calc(var(--topbar-h) + var(--page-pad-y))
        var(--page-pad-x)
        var(--page-pad-y)
        var(--page-pad-x);
      display:flex;
      align-items:center;
      justify-content:center;
    }

    /* CONTENT CONTAINER (white/translucent + wider + more vertical padding) */
    .inner-container{
      width: min(var(--inner-max), 100%);
      height: calc(100vh - (var(--topbar-h) + (var(--page-pad-y) * 2)));
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.55);
      background: var(--surface);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
      padding: var(--inner-pad-y) var(--inner-pad-x);
      color: var(--text);
    }

    .page-content{ height:100%; overflow:hidden; }
    .section[data-inner-scroll="true"] .page-content{
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      padding-right: 10px;
    }

    @media (max-width: 640px){
      :root{ --page-pad-x: 14px; --page-pad-y: 16px; --inner-pad-y: 34px; }
      .brand-title .sub{ display:none; }
      .dropdown{ width: min(340px, calc(100vw - 28px)); right: 14px; }
      .profilebox{ display:none; }
    }
  </style>
</head>

<body>
  <div id="video-bg" aria-hidden="true">
    <video id="bgA" autoplay muted playsinline preload="auto"></video>
    <video id="bgB" autoplay muted playsinline preload="auto"></video>
    <div class="bg-overlay"></div>
  </div>

  <!-- TOPBAR -->
  <header id="topbar">
    <div class="brand">
      <!-- PNG -->
      <img src="assets/logo/windkompass_logo.png" alt="WES WindKompass Logo" />
      <div class="brand-title">
        <div class="name">WES WindKompass</div>
        <div class="sub">Monitoring &amp; Auswertung</div>
      </div>
    </div>

    <div class="right" id="topbar-actions">
      <!-- profile + wind/temp -->
      <div class="profilebox">
        <img src="assets/profile/user.png" alt="Profil" />
        <div class="metas">
          <div class="user">Kevin</div>
          <div class="wx">üå¨Ô∏è 7 m/s ¬∑ 3¬∞C</div>
        </div>
      </div>

      <!-- bell -->
      <button class="icon-btn" type="button" data-action="toggle-notify" aria-label="Benachrichtigungen">
        <span class="badge" aria-label="2 Benachrichtigungen">2</span>
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2Z" fill="currentColor" opacity=".85"/>
          <path d="M18 16v-5a6 6 0 1 0-12 0v5l-2 2h16l-2-2Z" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round" opacity=".85"/>
        </svg>
        <span class="sr-only">Benachrichtigungen</span>
      </button>

      <!-- menu -->
      <button class="icon-btn" type="button" data-action="toggle-menu" aria-label="Men√º">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <line x1="4" y1="7" x2="20" y2="7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <line x1="4" y1="12" x2="20" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <line x1="4" y1="17" x2="20" y2="17" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
        <span class="sr-only">Men√º</span>
      </button>
    </div>
  </header>

  <!-- DROPDOWNS -->
  <div class="dropdown" id="notify-panel" role="menu" aria-label="Benachrichtigungen">
    <div class="drop-head">Benachrichtigungen</div>
    <ul class="drop-list">
      <li>
        <button class="drop-item" type="button">
          <div class="drop-title">Monatsberichte sind verf√ºgbar</div>
          <div class="drop-sub">Neue Auswertungen k√∂nnen jetzt ge√∂ffnet werden.</div>
        </button>
      </li>
      <li>
        <button class="drop-item" type="button">
          <div class="drop-title">Parkbetreuer</div>
          <div class="drop-sub">‚ÄûSch√∂nen guten Tag ‚Ä¶‚Äú</div>
        </button>
      </li>
    </ul>
  </div>

  <div class="dropdown" id="menu-panel" role="menu" aria-label="Navigation">
    <div class="drop-head">Navigation</div>
    <ul class="drop-list">
      <li><button class="drop-item" type="button" data-target="overview"><div class="drop-title">√úbersicht</div></button></li>
      <li><button class="drop-item" type="button" data-target="turbines"><div class="drop-title">Windenergieanlage</div></button></li>
      <li><button class="drop-item" type="button" data-target="redispatch"><div class="drop-title">Redispatch</div></button></li>
      <li><button class="drop-item" type="button" data-target="documents"><div class="drop-title">Dokumente</div></button></li>
      <li><button class="drop-item" type="button" data-target="account"><div class="drop-title">Konto</div></button></li>

      <li><hr class="sep"></li>

      <li><button class="drop-item logout" type="button" data-action="logout"><div class="drop-title">Abmelden</div></button></li>

      <li><hr class="sep"></li>

      <li><button class="drop-item" type="button" data-action="impressum"><div class="drop-title">Impressum &amp; Rechtliches</div></button></li>
    </ul>
  </div>

  <!-- SECTIONS -->
  <main id="sections">
    <section id="overview" class="section" data-inner-scroll="false">
      <div class="inner-container">
        <div class="page-content" data-load="sections/overview/content.html"></div>
      </div>
    </section>

    <section id="turbines" class="section" data-inner-scroll="true">
      <div class="inner-container">
        <div class="page-content" data-load="sections/turbines/content.html"></div>
      </div>
    </section>

    <section id="redispatch" class="section" data-inner-scroll="false">
      <div class="inner-container">
        <div class="page-content" data-load="sections/redispatch/content.html"></div>
      </div>
    </section>

    <section id="documents" class="section" data-inner-scroll="true">
      <div class="inner-container">
        <div class="page-content" data-load="sections/documents/content.html"></div>
      </div>
    </section>

    <section id="account" class="section" data-inner-scroll="true">
      <div class="inner-container">
        <div class="page-content">Konto (Demo)</div>
      </div>
    </section>
  </main>

  <script>
    const state = {
      index: 0,
      locked: false,
      sections: [],
      sectionIds: [],
      video: { list: [], idx: 0, fadeMs: 1200, fadeLeadMs: 1200, active: "A" }
    };

    const el = {
      stack: document.getElementById("sections"),
      bgA: document.getElementById("bgA"),
      bgB: document.getElementById("bgB"),
      actions: document.getElementById("topbar-actions"),
      notifyPanel: document.getElementById("notify-panel"),
      menuPanel: document.getElementById("menu-panel"),
      topbar: document.getElementById("topbar"),
    };

    init().catch(console.error);

    async function init(){
      state.sections = Array.from(document.querySelectorAll(".section"));
      state.sectionIds = state.sections.map(s => s.id);

      setupTopbarUI();
      setupScrollSnap();

      await loadAllSections();
      await setupVideoPlaylist();

      goTo(0, false);
    }

    function setupTopbarUI(){
      const closeAll = () => {
        el.notifyPanel.classList.remove("is-open");
        el.menuPanel.classList.remove("is-open");
      };

      el.actions.addEventListener("click", (e) => {
        const btn = e.target.closest("[data-action]");
        if(!btn) return;

        const a = btn.getAttribute("data-action");

        if (a === "toggle-notify"){
          const willOpen = !el.notifyPanel.classList.contains("is-open");
          closeAll();
          el.notifyPanel.classList.toggle("is-open", willOpen);
          return;
        }
        if (a === "toggle-menu"){
          const willOpen = !el.menuPanel.classList.contains("is-open");
          closeAll();
          el.menuPanel.classList.toggle("is-open", willOpen);
          return;
        }
      });

      el.menuPanel.addEventListener("click", (e) => {
        const t = e.target.closest("[data-target],[data-action]");
        if(!t) return;

        const target = t.getAttribute("data-target");
        const action = t.getAttribute("data-action");

        if (target){
          const i = state.sectionIds.indexOf(target);
          if (i >= 0) goTo(i);
          closeAll();
        }
        if (action === "logout"){
          alert("Abmelden (Demo)");
          closeAll();
        }
        if (action === "impressum"){
          alert("Impressum & Rechtliches (Demo)");
          closeAll();
        }
      });

      window.addEventListener("keydown", (e) => { if (e.key === "Escape") closeAll(); });

      window.addEventListener("click", (e) => {
        const path = e.composedPath ? e.composedPath() : [];
        const clickedTopbar = path.includes(el.topbar);
        const clickedNotify = path.includes(el.notifyPanel);
        const clickedMenu = path.includes(el.menuPanel);
        if (!clickedTopbar && !clickedNotify && !clickedMenu) closeAll();
      });
    }

    function setupScrollSnap(){
      window.addEventListener("wheel", onWheel, { passive:false });
      window.addEventListener("resize", () => goTo(state.index, false));
    }

    function onWheel(e){
      const inner = findInnerScrollable(e);
      if (inner && canInnerConsume(inner, e.deltaY)) return;

      e.preventDefault();
      if (state.locked) return;

      state.locked = true;
      const dir = Math.sign(e.deltaY);
      if (dir > 0) goTo(state.index + 1);
      if (dir < 0) goTo(state.index - 1);

      setTimeout(() => (state.locked = false), 520);
    }

    function findInnerScrollable(e){
      const path = e.composedPath ? e.composedPath() : [];
      return path.find(n =>
        n && n.classList && n.classList.contains("page-content") &&
        n.scrollHeight > n.clientHeight
      );
    }

    function canInnerConsume(inner, deltaY){
      const atTop = inner.scrollTop <= 0;
      const atBottom = inner.scrollTop + inner.clientHeight >= inner.scrollHeight - 1;
      if (deltaY > 0 && !atBottom) return true;
      if (deltaY < 0 && !atTop) return true;
      return false;
    }

    function goTo(i, animate=true){
      const max = state.sections.length - 1;
      const next = Math.max(0, Math.min(max, i));
      state.index = next;

      if (!animate) el.stack.style.transition = "none";
      el.stack.style.transform = `translateY(${-next * window.innerHeight}px)`;
      if (!animate) {
        void el.stack.offsetHeight;
        el.stack.style.transition = "";
      }
    }

    async function loadAllSections(){
      const targets = Array.from(document.querySelectorAll(".page-content[data-load]"));
      for (const container of targets){
        await loadHtmlInto(container, container.dataset.load);
      }
    }

    async function loadHtmlInto(container, url){
      try{
        const res = await fetch(url, { cache: "no-cache" });
        if(!res.ok) throw new Error(`Fetch failed ${res.status} for ${url}`);
        container.innerHTML = await res.text();
      }catch(err){
        container.innerHTML = `<div style="opacity:.75;">Fehler beim Laden: ${escapeHtml(url)}</div>`;
        console.error(err);
      }
    }

    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, s => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[s]));
    }

    async function setupVideoPlaylist(){
      try{
        const res = await fetch("assets/videos/manifest.json", { cache:"no-cache" });
        if(!res.ok) throw new Error("No videos manifest");
        const json = await res.json();

        state.video.fadeMs = typeof json.fadeMs === "number" ? json.fadeMs : state.video.fadeMs;
        state.video.fadeLeadMs = typeof json.fadeLeadMs === "number" ? json.fadeLeadMs : state.video.fadeLeadMs;
        state.video.list = (json.videos || []).map(v => v.startsWith("http") ? v : `assets/videos/${v}`);
        if(state.video.list.length === 0) throw new Error("Empty video list");

        document.documentElement.style.setProperty("--fade-ms", `${state.video.fadeMs}ms`);

        await setVideoSource(el.bgA, state.video.list[0]);
        el.bgA.classList.add("is-visible");
        el.bgB.classList.remove("is-visible");
        state.video.active = "A";

        attachFadeScheduler(el.bgA);
      }catch(err){
        console.warn("Video playlist disabled:", err);
      }
    }

    function attachFadeScheduler(videoEl){
      const onReady = () => scheduleFade(videoEl);
      videoEl.addEventListener("loadedmetadata", onReady, { once:true });
      if (videoEl.duration && isFinite(videoEl.duration)) scheduleFade(videoEl);
      videoEl.addEventListener("ended", () => scheduleFade(videoEl));
    }

    function scheduleFade(currentEl){
      const dur = currentEl.duration;
      if(!dur || !isFinite(dur)) return;

      const lead = state.video.fadeLeadMs / 1000;
      const t = Math.max(0, dur - lead);

      if (currentEl._fadeTimer) clearTimeout(currentEl._fadeTimer);
      currentEl._fadeTimer = setTimeout(() => crossfadeToNext(), t * 1000);
    }

    async function crossfadeToNext(){
      if(state.video.list.length < 2) return;

      state.video.idx = (state.video.idx + 1) % state.video.list.length;
      const nextSrc = state.video.list[state.video.idx];

      const from = state.video.active === "A" ? el.bgA : el.bgB;
      const to   = state.video.active === "A" ? el.bgB : el.bgA;

      await setVideoSource(to, nextSrc);

      to.classList.add("is-visible");
      from.classList.remove("is-visible");

      state.video.active = (state.video.active === "A") ? "B" : "A";
      attachFadeScheduler(to);
    }

    async function setVideoSource(videoEl, src){
      return new Promise((resolve) => {
        try { videoEl.pause(); } catch {}
        videoEl.removeAttribute("src");
        videoEl.load();

        videoEl.src = src;

        const onCanPlay = async () => {
          try { await videoEl.play(); } catch {}
          resolve();
        };
        videoEl.addEventListener("canplay", onCanPlay, { once:true });
        videoEl.load();
      });
    }
  </script>
</body>
</html>

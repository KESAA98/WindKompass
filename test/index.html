<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Monats-Schätzung</title>
  <style>
    :root{
      --bg:#ffffff;
      --card:#ffffff;
      --border:#e9eef3;
      --text:#0f172a;
      --muted:#64748b;
      --grid:#eef2f6;
      --line:#22c55e;
      --fill: rgba(34,197,94,.08);
      --marker:#cbd5e1;
      --valueBlue:#2563eb;
    }
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    .wrap{max-width:1100px; margin:24px auto; padding:0 16px;}
    .title{display:flex; align-items:baseline; justify-content:space-between; gap:16px; margin-bottom:10px;}
    .title h1{font-size:18px; margin:0; font-weight:700;}
    .title .sub{font-size:12px; color:var(--muted);}
    .card{
      background:var(--card); border:1px solid var(--border);
      border-radius:14px; padding:14px;
    }
    .hint{margin-top:10px; font-size:12px; color:var(--muted);}
    canvas{width:100%; height:360px; display:block;}
    .err{
      margin-top:10px; padding:10px 12px; border-radius:10px;
      background:#fff7ed; border:1px solid #fed7aa; color:#9a3412; font-size:12px;
      display:none;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="title">
      <div>
        <h1>Monatsmarktwert Wind Onshore – aktueller Monat (Schätzung)</h1>
        <div class="sub" id="subline">–</div>
      </div>
      <div class="sub" id="updated">–</div>
    </div>

    <div class="card">
      <canvas id="chart"></canvas>
      <div class="err" id="err"></div>
      <div class="hint">
        Hinweis: Schätzung = Spotmarktpreis (Netztransparenz) gewichtet mit Wind-Onshore-Erzeugung (SMARD).
        Vormonat bleibt vorerst Schätzung und wird später automatisch ersetzt, sobald der offizielle Monatsmarktwert verfügbar ist.
      </div>
    </div>
  </div>

<script>
(() => {
  const PATH_CURRENT = "../data/price_current_month.json";
  const PATH_PREV    = "../data/price_prev_month.json";

  const elSub = document.getElementById("subline");
  const elUpd = document.getElementById("updated");
  const elErr = document.getElementById("err");
  const c = document.getElementById("chart");
  const ctx = c.getContext("2d");

  const dpr = Math.max(1, Math.floor(window.devicePixelRatio || 1));

  function fmtEUR(v){
    if (v == null || !isFinite(v)) return "–";
    return `${v.toFixed(2)} €/MWh`;
  }

  function parseLabel(label){
    // "dd.mm HH:00"
    const m = label.match(/^(\d{2})\.(\d{2})\s+(\d{2}):00$/);
    if(!m) return null;
    return { dd:+m[1], mm:+m[2], hh:+m[3] };
  }

  async function loadJson(url){
    const bust = `?v=${Date.now()}`;
    const r = await fetch(url + bust, { cache:"no-store" });
    if(!r.ok) throw new Error(`Fetch ${url} failed: ${r.status}`);
    return await r.json();
  }

  function resize(){
    const rect = c.getBoundingClientRect();
    c.width  = Math.round(rect.width * dpr);
    c.height = Math.round(rect.height * dpr);
  }

  function toDailySeries(series6h){
    // Glättung: 1 Punkt pro Tag (Daily-Average)
    const map = new Map(); // day -> {sum,n,dd}
    for (const p of (series6h || [])) {
      const t = parseLabel(p.label);
      if(!t) continue;
      const y = +p.value;
      if(!isFinite(y)) continue;
      const key = `${t.dd}.${t.mm}`;
      const o = map.get(key) || {sum:0,n:0,dd:t.dd,mm:t.mm};
      o.sum += y; o.n += 1;
      map.set(key, o);
    }
    return [...map.values()]
      .sort((a,b)=> (a.mm-b.mm) || (a.dd-b.dd))
      .map(o => ({ x:(o.dd - 1) + 0.5, y:o.sum / o.n, dd:o.dd }));
  }

  function draw(current, prev){
    resize();
    ctx.setTransform(1,0,0,1,0,0);
    ctx.clearRect(0,0,c.width,c.height);

    // smoother, weniger "comic"
    ctx.lineJoin = "round";
    ctx.lineCap  = "round";

    const W = c.width, H = c.height;
    const padL = 18*dpr, padT = 14*dpr, padB = 22*dpr, padR = 18*dpr;
    const labelZone = Math.round(220 * dpr);
    const plotW = W - padL - padR - labelZone;
    const plotH = H - padT - padB;
    const plotX0 = padL;
    const plotY0 = padT;

    const series = toDailySeries(current.series_6h);

    if(series.length < 2){
      elErr.style.display = "block";
      elErr.textContent = "Noch keine Daten vorhanden (series_6h leer).";
      return;
    } else {
      elErr.style.display = "none";
    }

    const [yy, mm] = (current.month || "").split("-").map(Number);
    const daysInMonth = new Date(yy, mm, 0).getDate();
    const xMin = 0;
    const xMax = daysInMonth;

    const ys = series.map(p => p.y);
    let yMin = Math.min(...ys);
    let yMax = Math.max(...ys);
    const padY = (yMax - yMin) * 0.12 || 8;
    yMin -= padY; yMax += padY;

    const xToPx = x => plotX0 + (x - xMin) / (xMax - xMin) * plotW;
    const yToPx = y => plotY0 + (yMax - y) / (yMax - yMin) * plotH;

    // Grid
    ctx.lineWidth = 1*dpr;
    ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue("--grid").trim();
    ctx.beginPath();
    for(let i=0;i<=4;i++){
      const yy = plotY0 + (plotH/4)*i;
      ctx.moveTo(plotX0, yy);
      ctx.lineTo(plotX0 + plotW, yy);
    }
    ctx.stroke();

    // Area
    ctx.beginPath();
    ctx.moveTo(xToPx(series[0].x), yToPx(series[0].y));
    for(const p of series) ctx.lineTo(xToPx(p.x), yToPx(p.y));
    ctx.lineTo(xToPx(series[series.length-1].x), plotY0 + plotH);
    ctx.lineTo(xToPx(series[0].x), plotY0 + plotH);
    ctx.closePath();
    ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue("--fill").trim();
    ctx.fill();

    // Line
    ctx.beginPath();
    ctx.moveTo(xToPx(series[0].x), yToPx(series[0].y));
    for(const p of series) ctx.lineTo(xToPx(p.x), yToPx(p.y));
    ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue("--line").trim();
    ctx.lineWidth = 2*dpr;
    ctx.stroke();

    // Marker: heutiger Tag (today_index) -> x = day + 0.5
    const dayIndex = Math.min(Math.max(0, +current.today_index || (series.length-1)), daysInMonth-1);
    const xNow = xToPx(dayIndex + 0.5);

    // Marker-Linie
    ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue("--marker").trim();
    ctx.lineWidth = 2*dpr;
    ctx.beginPath();
    ctx.moveTo(xNow, plotY0);
    ctx.lineTo(xNow, plotY0 + plotH);
    ctx.stroke();

    // value line in label zone
    const estCur = current.estimate_eur_mwh;

    const prevIsOfficial = !!prev.official_available && prev.official_eur_mwh != null;
    const prevValue = prevIsOfficial ? prev.official_eur_mwh : prev.estimate_eur_mwh;

    // y position for connector: use last known daily point <= today; fallback last
    const pIdx = Math.min(series.length-1, Math.max(0, series.findIndex(p => p.dd === (dayIndex+1)) ));
    const pNow = series[pIdx >= 0 ? pIdx : (series.length-1)];
    const yNow = yToPx(pNow.y);

    const xRight = plotX0 + plotW + 14*dpr;
    ctx.beginPath();
    ctx.moveTo(xNow, yNow);
    ctx.lineTo(xRight + labelZone - 20*dpr, yNow);
    ctx.stroke();

    const textX = xRight + 12*dpr;
    const topY  = Math.max(plotY0 + 16*dpr, Math.min(plotY0 + plotH - 40*dpr, yNow - 10*dpr));
    const botY  = topY + 44*dpr;

    ctx.textAlign = "left";
    ctx.textBaseline = "alphabetic";

    // aktuell (grün)
    ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue("--line").trim();
    ctx.font = `${18*dpr}px system-ui, -apple-system, Segoe UI, Roboto, Arial`;
    ctx.fillText(fmtEUR(estCur), textX, topY);

    ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue("--muted").trim();
    ctx.font = `${12*dpr}px system-ui, -apple-system, Segoe UI, Roboto, Arial`;
    ctx.fillText("Schätzung aktuell", textX, topY + 16*dpr);

    // Vormonat (blau)
    ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue("--valueBlue").trim();
    ctx.font = `${18*dpr}px system-ui, -apple-system, Segoe UI, Roboto, Arial`;
    ctx.fillText(fmtEUR(prevValue), textX, botY);

    ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue("--muted").trim();
    ctx.font = `${12*dpr}px system-ui, -apple-system, Segoe UI, Roboto, Arial`;
    ctx.fillText(prevIsOfficial ? "Vormonat (offiziell)" : "Vormonat (Schätzung)", textX, botY + 16*dpr);

    // x labels
    ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue("--muted").trim();
    ctx.font = `${11*dpr}px system-ui, -apple-system, Segoe UI, Roboto, Arial`;
    ctx.textAlign = "left";
    ctx.fillText(`01`, plotX0, plotY0 + plotH + 16*dpr);
    ctx.textAlign = "right";
    ctx.fillText(`${daysInMonth}`, plotX0 + plotW, plotY0 + plotH + 16*dpr);
    ctx.textAlign = "left";
  }

  async function init(){
    try{
      const [current, prev] = await Promise.all([loadJson(PATH_CURRENT), loadJson(PATH_PREV)]);

      const [yy, mm] = (current.month || "").split("-").map(Number);
      const dim = new Date(yy, mm, 0).getDate();

      elSub.textContent = `${current.month}-01 → ${current.month}-${String(dim).padStart(2,"0")} (${current.bzn || "–"})`;
      elUpd.textContent = `Update: ${current.updated_utc || "–"}`;

      draw(current, prev);
      window.addEventListener("resize", () => draw(current, prev));
    } catch(e){
      elErr.style.display = "block";
      elErr.textContent = "Fehler beim Laden der JSON: " + (e?.message || e);
    }
  }

  init();
})();
</script>
</body>
</html>

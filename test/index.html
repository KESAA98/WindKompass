<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Monats-Schätzung</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root{
      --bg:#fff;
      --text:#0f172a;
      --muted:#64748b;
      --grid:rgba(15,23,42,.08);
      --green:#16a34a;
      --greenFill:rgba(22,163,74,.18);
    }
    body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--text);}
    .wrap{max-width:1100px;margin:26px auto;padding:0 16px;}
    .head{display:flex;justify-content:space-between;align-items:flex-end;gap:12px;flex-wrap:wrap;margin-bottom:10px}
    h1{font-size:18px;margin:0;font-weight:750;letter-spacing:-.01em}
    .sub{font-size:13px;color:var(--muted);margin-top:3px}
    .kpi{font-size:26px;font-weight:800;letter-spacing:-.02em}
    .kpi small{font-size:13px;color:var(--muted);font-weight:650;margin-left:8px}
    .box{border:1px solid rgba(15,23,42,.10);border-radius:14px;padding:10px 10px 6px 10px;}
    canvas{width:100% !important;height:420px !important;}
    .err{display:none;margin-top:10px;font-size:13px;color:#b45309;background:rgba(251,191,36,.18);border:1px solid rgba(251,191,36,.35);border-radius:12px;padding:10px 12px;}
    @media (max-width: 900px){canvas{height:360px !important;}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="head">
      <div>
        <h1>Day-Ahead Börsenpreis – aktueller Monat</h1>
        <div class="sub" id="subtitle">Lädt…</div>
      </div>
      <div class="kpi"><span id="kpi">—</span><small>€/MWh (Schätzung)</small></div>
    </div>

    <div class="box">
      <canvas id="c"></canvas>
      <div class="err" id="err"></div>
    </div>
  </div>

<script>
  const BZN = "DE-LU";
  const TZ  = "Europe/Berlin";

  // Optional: offizieller Monatsmarktwert (Vormonat) – später per API/Proxy automatisieren
  let OFFICIAL_LAST_MONTH = null; // z.B. 78.12

  function berlinNow(){ return new Date(new Date().toLocaleString("en-US",{timeZone:TZ})); }
  function iso(d){
    const x = new Date(d.toLocaleString("en-US",{timeZone:TZ}));
    return `${x.getFullYear()}-${String(x.getMonth()+1).padStart(2,"0")}-${String(x.getDate()).padStart(2,"0")}`;
  }
  function startOfMonth(){
    const n = berlinNow();
    return new Date(n.getFullYear(), n.getMonth(), 1);
  }
  function endOfMonth(){
    const n = berlinNow();
    return new Date(n.getFullYear(), n.getMonth()+1, 0);
  }
  function avg(a){
    const x = a.filter(v=>Number.isFinite(v));
    return x.length ? x.reduce((s,v)=>s+v,0)/x.length : NaN;
  }

  // 6h Aggregation: 00-05 / 06-11 / 12-17 / 18-23
  function to6h(unixSeconds, prices){
    const map = new Map();
    for(let i=0;i<unixSeconds.length;i++){
      const p = Number(prices[i]);
      if(!Number.isFinite(p)) continue;
      const t = unixSeconds[i]*1000;
      const b = new Date(new Date(t).toLocaleString("en-US",{timeZone:TZ}));
      const block = Math.floor(b.getHours()/6);
      const key = `${b.getFullYear()}-${b.getMonth()+1}-${b.getDate()}-${block}`;
      if(!map.has(key)) map.set(key,{t, sum:0, n:0, day:b.getDate(), mon:b.getMonth()+1, block});
      const o = map.get(key); o.sum += p; o.n++;
    }
    return Array.from(map.values()).sort((a,b)=>a.t-b.t).map(o=>{
      const hh = String(o.block*6).padStart(2,"0");
      return { label:`${String(o.day).padStart(2,"0")}.${String(o.mon).padStart(2,"0")} ${hh}:00`, value:o.sum/(o.n||1) };
    });
  }

  // Plugin: “Strich nach rechts raus” + Texte
  const calloutPlugin = {
    id:"callout",
    afterDatasetsDraw(chart, args, opts){
      const {ctx, chartArea} = chart;
      const meta = chart.getDatasetMeta(0);
      const idx = opts.todayIndex;
      if(!meta?.data?.length || idx==null || idx<0 || idx>=meta.data.length) return;

      const pt = meta.data[idx];
      const x = pt.x, y = pt.y;
      const x2 = chartArea.right + 26;

      ctx.save();
      ctx.strokeStyle = "rgba(22,163,74,.95)";
      ctx.lineWidth = 2;
      ctx.beginPath(); ctx.moveTo(x,y); ctx.lineTo(x2,y); ctx.stroke();

      ctx.fillStyle = "rgba(22,163,74,.95)";
      ctx.beginPath(); ctx.arc(x2,y,3.6,0,Math.PI*2); ctx.fill();

      ctx.fillStyle = "#0f172a";
      ctx.font = "800 13px system-ui,-apple-system,Segoe UI,Roboto,Arial";
      ctx.textBaseline = "bottom";
      ctx.fillText(opts.topText || "", x2+10, y-6);

      if(opts.bottomText){
        ctx.fillStyle = "rgba(15,23,42,.72)";
        ctx.font = "700 12px system-ui,-apple-system,Segoe UI,Roboto,Arial";
        ctx.textBaseline = "top";
        ctx.fillText(opts.bottomText, x2+10, y+6);
      }
      ctx.restore();
    }
  };
  Chart.register(calloutPlugin);

  let chart;

  async function load(){
    const err = document.getElementById("err");
    err.style.display="none";

    const s = startOfMonth(), e = endOfMonth();
    const start = iso(s), end = iso(e);
    document.getElementById("subtitle").textContent = `${start} → ${end} (${BZN})`;

    const url = `https://api.energy-charts.info/price?bzn=${encodeURIComponent(BZN)}&start=${start}&end=${end}`;
    let json;
    try{
      const r = await fetch(url, {cache:"no-store"});
      if(!r.ok) throw new Error(`HTTP ${r.status}`);
      json = await r.json();
    }catch(ex){
      err.style.display="block";
      err.textContent = `API-Fehler: ${ex.message}`;
      return;
    }

    const unix = json.unix_seconds;
    const prices = json.price;
    if(!Array.isArray(unix) || !Array.isArray(prices) || unix.length===0){
      err.style.display="block";
      err.textContent = "Unerwartetes API-Format (unix_seconds/price fehlen).";
      return;
    }

    const pts = to6h(unix, prices);
    const labels = pts.map(p=>p.label);
    const values = pts.map(p=>p.value);

    const now = berlinNow();
    const todayPrefix = `${String(now.getDate()).padStart(2,"0")}.${String(now.getMonth()+1).padStart(2,"0")}`;
    const todayIndex = labels.findIndex(l=>l.startsWith(todayPrefix));
    const idx = todayIndex>=0 ? todayIndex : values.length-1;

    // Schätzung: Ø bis heute + Rest = Ø letzte 7 Tage (simpel & stabil)
    const soFar = values.slice(0, idx+1);
    const soFarMean = avg(soFar);

    const uniqueDays = [...new Set(labels.map(l=>l.slice(0,5)))];
    const last7Days = uniqueDays.slice(-7);
    const last7Vals = pts.filter(p=>last7Days.includes(p.label.slice(0,5))).map(p=>p.value);
    const restMean = avg(last7Vals);

    const daysInMonth = new Date(now.getFullYear(), now.getMonth()+1, 0).getDate();
    const part = (now.getDate()-1)/daysInMonth;

    const estimate = (Number.isFinite(soFarMean) && Number.isFinite(restMean))
      ? (soFarMean*part + restMean*(1-part))
      : soFarMean;

    document.getElementById("kpi").textContent = Number.isFinite(estimate) ? estimate.toFixed(2) : "—";

    const topText = `Schätzung: ${Number.isFinite(estimate) ? estimate.toFixed(2) : "—"} €/MWh`;
    let bottomText = "";
    if(now.getDate() >= 10){
      bottomText = `Vormonat (offiziell): ${OFFICIAL_LAST_MONTH==null ? "—" : OFFICIAL_LAST_MONTH.toFixed(2)} €/MWh`;
    }

    if(chart) chart.destroy();
    chart = new Chart(document.getElementById("c"),{
      type:"line",
      data:{
        labels,
        datasets:[{
          data:values,
          borderColor:"rgba(22,163,74,.95)",
          backgroundColor:"rgba(22,163,74,.18)",
          fill:true,
          tension:0.25,
          pointRadius:0,
          borderWidth:2
        }]
      },
      options:{
        maintainAspectRatio:false,
        layout:{ padding:{ right: 170 } }, // Platz für den Callout rechts
        plugins:{
          legend:{display:false},
          tooltip:{ callbacks:{ label:(c)=>` ${c.parsed.y.toFixed(2)} €/MWh` } },
          callout:{ todayIndex: idx, topText, bottomText }
        },
        scales:{
          x:{ grid:{ color:"rgba(15,23,42,.06)" }, ticks:{ maxTicksLimit: 10 } },
          y:{ grid:{ color:"rgba(15,23,42,.06)" } }
        }
      }
    });
  }

  load();
</script>
</body>
</html>
